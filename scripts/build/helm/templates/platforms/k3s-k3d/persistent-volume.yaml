{{- if and (eq (toString .Values.couchdb.clusteredCouchEnabled) "false") (eq (toString .Values.cluster_type) "k3s-k3d") (eq (toString .Values.couchdb_data.preExistingDataAvailable) "true") }}
apiVersion: v1
kind: PersistentVolume
metadata:
  name: couchdb-pv-{{ .Values.namespace }}
spec:
  capacity:
    storage: {{ .Values.couchdb.couchdb_node_storage_size }}
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-path
  hostPath:
    path: {{ index .Values.local_storage "preExistingDiskPath-1" }}
    type: DirectoryOrCreate
---
{{- end }}

{{- if and (eq (toString .Values.couchdb.clusteredCouchEnabled) "true") (eq (toString .Values.cluster_type) "k3s-k3d") (eq (toString .Values.couchdb_data.preExistingDataAvailable) "true") }}
{{- range $i, $e := until (int .Values.clusteredCouch.noOfCouchDBNodes) }}
{{ $nodeNumber := add $i 1 }}
apiVersion: v1
kind: PersistentVolume
metadata:
  name: couchdb-pv-{{ $.Values.namespace }}-{{ $nodeNumber }}
spec:
  capacity:
    storage: {{ $.Values.couchdb.couchdb_node_storage_size }}
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-path
  hostPath:
    path: {{ index $.Values.local_storage (printf "preExistingDiskPath-%d" $nodeNumber) }}
    type: DirectoryOrCreate
---
{{- end }}
{{- end }}
